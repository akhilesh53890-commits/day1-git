<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Students Hub ‚Äî Campus Guide</title>
<style>
      /* QuickServe menu button theme override */
      .action-button.quickserve-menu {
        background: var(--accent) !important;
        color: #fff !important;
        border: none;
        box-shadow: 0 2px 12px #ff4c4c33;
        transition: background 0.3s, color 0.3s, box-shadow 0.3s;
      }
      .action-button.quickserve-menu:hover {
        background: var(--green) !important;
        color: #121212 !important;
        box-shadow: 0 4px 24px #14b21455;
      }
    /* --- Explore Campus Blog Slide --- */
    .explore-blog {
      background: var(--panel);
      border-radius: 16px;
      box-shadow: 0 8px 32px #000a, 0 2px 16px #14b21433;
      margin-top: 18px;
      padding: 28px 24px;
      color: #fff;
      animation: blog-fadein 0.7s cubic-bezier(.4,2,.6,1);
      position: relative;
      min-height: 180px;
      z-index: 10;
    }
    @keyframes blog-fadein {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: none; }
    }
    .food-card.explore-clickable { cursor: pointer; transition: box-shadow 0.3s, transform 0.3s; }
    .food-card.explore-clickable:active { transform: scale(0.97); }
    .food-card.explore-slideout img {
      animation: img-slideout 0.6s cubic-bezier(.4,2,.6,1) forwards;
    }
    @keyframes img-slideout {
      to { transform: translateX(120%) scale(0.8) rotate(8deg); opacity: 0; }
    }
  /* ---------- GLOBAL RESET & BASE ---------- */
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#121212; --panel:#1f1f20; --muted:#bdbdbd; --accent:#ff4c4c; --green:#14b214;
    --card:#2a2a2a; --input:#232324;
  }
  html {
    scroll-behavior: smooth;
  }
  body{
    font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg); color:#e6e6e6;
    display:flex; min-height:100vh;
    animation: bg-move 18s linear infinite alternate;
    background: linear-gradient(120deg, #121212 0%, #232324 100%);
    background-size: 200% 200%;
  }
  @keyframes bg-move {
    0% { background-position: 0% 50%; }
    100% { background-position: 100% 50%; }
  }

  /* ---------- SIDEBAR ---------- */
  .sidebar{
    width:250px;background:#181818;padding:22px;display:flex;flex-direction:column;gap:14px;
    border-right:1px solid rgba(255,255,255,0.02);
    overflow-y:auto;
    box-shadow: 0 0 32px 0 rgba(255,76,76,0.08);
    animation: sidebar-float 4s ease-in-out infinite alternate;
  }
  @keyframes sidebar-float {
    0% { transform: translateY(0px); }
    100% { transform: translateY(10px); }
  }
  .logo{display:flex;align-items:center;gap:12px;color:#fff;font-weight:800;font-size:19px;letter-spacing:1.5px;transition:transform 0.3s cubic-bezier(.4,2,.6,1);}
  .logo:hover { transform: scale(1.08) rotate(-2deg); text-shadow: 0 2px 16px #ff4c4c44; }
  .logo .icon{
    width:36px;height:36px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:900;
    box-shadow: 0 2px 12px #ff4c4c55;
    animation: icon-bounce 2.2s infinite cubic-bezier(.6,0,.4,1);
    transition: box-shadow 0.3s;
  }
  @keyframes icon-bounce {
    0%,100% { transform: translateY(0); }
    50% { transform: translateY(-8px) scale(1.12); }
  }
  .nav-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:12px;color:#b2b2b2;cursor:pointer;transition:background 0.3s, color 0.3s, transform 0.25s;position:relative;overflow:hidden;}
  .nav-item:hover{
    background:linear-gradient(90deg,#232324 60%,#ff4c4c22 100%);
    color:#fff;
    transform:translateX(6px) scale(1.04);
    box-shadow:0 2px 16px #ff4c4c22;
  }
  .nav-item.active{
    background:var(--accent);color:#fff;
    box-shadow:0 2px 16px #ff4c4c55;
    transform:scale(1.06);
  }
  .nav-item .icon{
    width:36px;height:36px;background:#2b2b2b;border-radius:8px;display:flex;align-items:center;justify-content:center;
    transition:background 0.3s, transform 0.3s;
  }
  .nav-item:hover .icon{
    background:var(--accent);
    transform:scale(1.12) rotate(-8deg);
  }

  /* ---------- MAIN ---------- */
  .main{flex:1;display:flex;flex-direction:column;overflow:auto;padding:28px 34px;animation: main-fadein 1.2s cubic-bezier(.4,2,.6,1);}
  @keyframes main-fadein {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: none; }
  }

  .top-nav{display:flex;justify-content:flex-end;gap:18px;align-items:center;margin-bottom:18px}
  .top-nav a{color:#9e9e9e;text-decoration:none}
  .login-button{background:var(--accent);border-radius:10px;padding:8px 14px;border:none;color:#000;font-weight:700;cursor:pointer}

  /* ---------- CARD / GRID BASE ---------- */
  .card-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:22px;}
  .card{
    background:var(--panel);border-radius:14px;padding:18px;color:#ddd;display:flex;flex-direction:column;gap:12px;
    box-shadow:0 4px 32px #000a, 0 1.5px 8px #ff4c4c11;
    position:relative;overflow:hidden;
    transition:transform 0.35s cubic-bezier(.4,2,.6,1), box-shadow 0.3s;
    animation: card-pop 0.8s cubic-bezier(.4,2,.6,1) backwards;
  }
  .card:hover {
    transform:translateY(-12px) scale(1.045) rotate(-1.5deg);
    box-shadow:0 8px 40px #ff4c4c33, 0 2px 16px #14b21433;
    z-index:2;
  }
  @keyframes card-pop {
    from { opacity:0; transform:translateY(60px) scale(0.95); }
    to { opacity:1; transform:none; }
  }
  .card-emoji{
    font-size:42px;background:#333;width:70px;height:70px;border-radius:12px;display:flex;align-items:center;justify-content:center;
    box-shadow:0 2px 12px #14b21433;
    transition:background 0.3s, transform 0.3s;
    animation: emoji-float 2.5s infinite alternate cubic-bezier(.4,2,.6,1);
  }
  .card:hover .card-emoji{
    background:var(--green);color:#000;transform:scale(1.13) rotate(8deg);
    box-shadow:0 4px 24px #14b21455;
  }
  @keyframes emoji-float {
    0% { transform: translateY(0); }
    100% { transform: translateY(-10px) scale(1.08); }
  }
  .card-title{color:var(--accent);font-weight:800;font-size:1.25rem;letter-spacing:0.5px;transition:color 0.3s;}
  .card:hover .card-title{color:var(--green);}
  .card-desc{color:#bdbdbd;font-size:0.95rem;transition:color 0.3s;}
  .card:hover .card-desc{color:#fff;}
  .card-button{
    background:var(--accent);border:none;padding:10px 12px;border-radius:10px;color:#000;font-weight:800;cursor:pointer;align-self:flex-start;
    box-shadow:0 2px 12px #ff4c4c33;
    transition:background 0.3s, color 0.3s, box-shadow 0.3s;
    position:relative;overflow:hidden;
  }
  .card-button:hover{
    background:var(--green);color:#fff;box-shadow:0 4px 24px #14b21455;
  }
  .card-button:active::after{
    content:'';position:absolute;left:50%;top:50%;width:120%;height:120%;background:radial-gradient(circle,#fff3 10%,transparent 70%);transform:translate(-50%,-50%);pointer-events:none;animation:ripple 0.5s linear;
  }
  @keyframes ripple {
    from { opacity:0.7; }
    to { opacity:0; }
  }

  /* ---------- FACULTY FINDER LAYOUT ---------- */
  .page-header{font-size:44px;color:#ff6b6b;margin-bottom:6px;font-weight:900}
  .page-subheader{color:var(--green);font-size:18px;margin-bottom:20px}

  .finder-controls{display:flex;gap:16px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
  .search-input{
    flex:1;min-width:280px;height:56px;background:var(--input);border-radius:14px;padding:12px 16px;display:flex;align-items:center;gap:12px;border:1px solid rgba(255,255,255,0.03)
  }
  .search-input input{background:transparent;border:0;color:#dcdcdc;font-size:16px;width:100%;outline:none}
  .dropdown{
    width:220px;height:56px;border-radius:14px;background:var(--input);display:flex;align-items:center;justify-content:space-between;padding:0 14px;color:#ddd;cursor:pointer;border:1px solid rgba(255,255,255,0.03)
  }

  /* Faculty grid cards */
  .faculty-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
  .faculty-card{
    background:var(--panel);border-radius:18px;padding:26px;display:flex;flex-direction:column;gap:10px;min-height:220px;
    box-shadow:0 6px 16px rgba(0,0,0,0.6);
    transition:transform 0.3s, box-shadow 0.3s;
    animation: card-pop 0.8s cubic-bezier(.4,2,.6,1) backwards;
    position:relative;overflow:hidden;
  }
  .faculty-card:hover {
    transform:translateY(-10px) scale(1.04) rotate(1.5deg);
    box-shadow:0 8px 40px #14b21433, 0 2px 16px #ff4c4c33;
    z-index:2;
  }
  .faculty-name{color:var(--green);font-weight:900;font-size:20px;letter-spacing:0.4px}
  .faculty-role{color:#bfbfbf;font-weight:600;font-size:14px}
  .faculty-meta{display:flex;flex-direction:column;gap:8px;color:#cfcfcf;margin-top:6px;font-size:14px}
  .meta-row{display:flex;align-items:center;gap:10px;opacity:0.95}

  .email-link{color:#dcdcdc;text-decoration:none}
  .email-link:hover{text-decoration:underline}

  /* pill dept on card */
  .dept-pill{background:#2a2a2a;padding:8px 10px;border-radius:999px;color:#dcdcdc;font-weight:700;font-size:13px;align-self:flex-end}

  /* What's in Mess styles (reused) */
  .mess-tabs, .day-tabs, .meal-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }
  .mess-tab, .day-tab, .meal-tab {
    cursor: pointer;
    padding: 8px 16px;
    border-radius: 25px;
    user-select: none;
    font-weight: 600;
    font-size: 0.95rem;
    background-color: #2a2a2a;
    color: #bbb;
    transition: background-color 0.25s ease, color 0.25s ease;
  }
  .mess-tab.active, .day-tab.active, .meal-tab.active {
    background-color: var(--green);
    color: black;
  }

  .meal-tab.snacks.active {
    background-color: #3a83f1;
    color: white;
    border: 3px solid #ffd700;
    position: relative;
  }
  .meal-tab.snacks.active::after {
    content: "NOW";
    position: absolute;
    top: -10px;
    right: -10px;
    background-color: #ffd700;
    color: #121212;
    padding: 2px 6px;
    font-size: 0.75rem;
    font-weight: 900;
    border-radius: 12px;
  }

  .meal-section {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }

  .item-box {
    background-color: #1a1a1a;
    border-radius: 12px;
    padding: 12px 20px;
    min-width: 100px;
    font-weight: 700;
    text-align: center;
    user-select: none;
    cursor: default;
    border: 2px solid transparent;
    color: #ddd;
  }

  

  /* QuickServe food cards */
  .food-card-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px}
  .food-card{
    background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;
    box-shadow:0 2px 16px #000a, 0 1.5px 8px #ff4c4c11;
    position:relative;overflow:hidden;
    transition:transform 0.35s cubic-bezier(.4,2,.6,1), box-shadow 0.3s;
    animation: foodcard-pop 0.8s cubic-bezier(.4,2,.6,1) backwards;
  }
  .food-card:hover {
    transform:translateY(-10px) scale(1.045) rotate(-1.5deg);
    box-shadow:0 8px 40px #ff4c4c33, 0 2px 16px #14b21433;
    z-index:2;
  }
  @keyframes foodcard-pop {
    from { opacity:0; transform:translateY(60px) scale(0.95); }
    to { opacity:1; transform:none; }
  }
  .food-card img{width:100%;height:140px;object-fit:cover;border-radius:8px;transition:transform 0.3s, box-shadow 0.3s;}
  .food-card:hover img{transform:scale(1.07) rotate(-2deg);box-shadow:0 4px 24px #14b21455;}
  .food-info h3{margin:0;color:#fff;transition:color 0.3s;}
  .food-card:hover .food-info h3{color:var(--green);}

  /* Responsive adjustments */
  @media (max-width:1200px){
    .faculty-grid{grid-template-columns:repeat(3,1fr)}
  }
  @media (max-width:900px){
    .sidebar{display:none}
    .main{padding:18px}
    .faculty-grid{grid-template-columns:repeat(2,1fr)}
    .page-header{font-size:34px}
  }
  @media (max-width:560px){
    .faculty-grid{grid-template-columns:1fr}
    .finder-controls{flex-direction:column;align-items:stretch}
    .dropdown{width:100%}
  }

  /* small helper visuals for icons */
  .icon-svg{width:16px;height:16px;opacity:0.9}
  /* ----- Login modal ----- */
  /* backdrop sits behind the modal content (z-index:1) so the dialog stays sharp */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1000}
  .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.55);z-index:1;-webkit-backdrop-filter:blur(3px);backdrop-filter:blur(3px)}
  .modal-content{position:relative;z-index:2;background:var(--panel);padding:18px;border-radius:12px;min-width:320px;max-width:420px;color:#fff;box-shadow:0 8px 36px rgba(0,0,0,0.7)}
  .modal-content h3{margin:0 0 8px 0;font-size:18px}
  .modal-content input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--input);color:#e6e6e6;margin-top:8px}
  .modal-actions{Display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
</style>
</style>
<script>
// --- Explore Campus Blog Data ---
const exploreCampusBlogs = {
  'SportX Arena': {
    title: 'SportX Arena',
    content: `<b>SportX Arena</b> is the heart of campus sports, featuring indoor and outdoor courts for badminton, squash, basketball, and more. Students gather here for tournaments, fitness, and fun. The vibrant atmosphere and modern facilities make it a favorite hangout for athletes and fans alike.`
  },
  'Central Library': {
    title: 'Central Library',
    content: `<b>Central Library</b> offers a peaceful study space with thousands of books and digital resources. Whether you need a quiet corner or group study room, the library is the go-to place for academic success and research.`
  },
  'Admin Block': {
    title: 'Admin Block',
    content: `<b>Admin Block</b> houses administrative offices, admissions, and student support services. It's where you handle official paperwork, meet staff, and get guidance for your campus journey.`
  },
  'RACE': {
    title: 'RACE',
    content: `<b>RACE</b> (Research & Advanced Computing Excellence) is the innovation hub for tech enthusiasts. Cutting-edge labs, collaborative projects, and events make it the center for research and discovery.`
  }
};

// --- Explore Campus Card Click Handler ---
function addExploreCampusCardEvents() {
  const container = document.querySelector('.food-card-container');
  if (!container) return;
  const cards = container.querySelectorAll('.food-card');
  cards.forEach(card => {
    const h3 = card.querySelector('h3');
    if (!h3) return;
    card.classList.add('explore-clickable');
    card.onclick = function() {
      // Slide out image
      const img = card.querySelector('img');
      if (img) img.classList.add('explore-slideout');
      card.classList.add('explore-slideout');
      // After slide, show blog
      setTimeout(() => {
        const blog = exploreCampusBlogs[h3.textContent.trim()];
        if (!blog) return;
        // Remove all cards and show blog
        container.innerHTML = `<div class='explore-blog'><h2 style='color:var(--green);margin-bottom:12px'>${blog.title}</h2><div>${blog.content}</div><button class='action-button' id='exploreBackBtn' style='margin-top:22px'>Back to Explore</button></div>`;
        document.getElementById('exploreBackBtn').onclick = function() {
          // Reload explore campus page
          if (window.loadPage) window.loadPage('explorecampus');
        };
      }, 600);
    };
  });
}

// Patch loadPage to add events for explorecampus
const origLoadPageExplore = window.loadPage;
window.loadPage = function(page) {
  origLoadPageExplore(page);
  setTimeout(() => {
    if (page === 'explorecampus') addExploreCampusCardEvents();
  }, 100);
};
// --- Live motion: Parallax on mousemove for .main and .sidebar ---
document.addEventListener('mousemove', function(e) {
  const x = (e.clientX / window.innerWidth - 0.5) * 2;
  const y = (e.clientY / window.innerHeight - 0.5) * 2;
  document.querySelectorAll('.main, .sidebar').forEach(el => {
    el.style.transform = `translate3d(${x*8}px,${y*8}px,0)`;
  });
});

// --- Animate cards in with staggered delay ---
function animateCards() {
  document.querySelectorAll('.card, .faculty-card').forEach((el, i) => {
    el.style.animationDelay = (i * 0.12) + 's';
  });
  document.querySelectorAll('.food-card').forEach((el, i) => {
    el.style.animationDelay = (i * 0.10) + 's';
  });
}
setTimeout(animateCards, 400);
// Also re-run after page loads
window.addEventListener('load', animateCards);
// Re-animate after page loads for quickserve/explorecampus
const origLoadPage = window.loadPage;
window.loadPage = function(page) {
  origLoadPage(page);
  setTimeout(animateCards, 200);
};

// --- Ripple effect for all .card-button and .action-button ---
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.card-button, .action-button');
  if (!btn) return;
  const ripple = document.createElement('span');
  ripple.style.position = 'absolute';
  ripple.style.left = (e.offsetX || 0) + 'px';
  ripple.style.top = (e.offsetY || 0) + 'px';
  ripple.style.width = ripple.style.height = '120px';
  ripple.style.background = 'radial-gradient(circle,#fff3 10%,transparent 70%)';
  ripple.style.borderRadius = '50%';
  ripple.style.pointerEvents = 'none';
  ripple.style.transform = 'translate(-50%,-50%) scale(0.7)';
  ripple.style.opacity = '0.7';
  ripple.style.zIndex = 10;
  ripple.style.animation = 'ripple 0.5s linear forwards';
  btn.appendChild(ripple);
  setTimeout(()=>{ if(ripple.parentNode) ripple.parentNode.removeChild(ripple); }, 500);
});
</script>
</head>
<body>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="logo"><div class="icon">O</div>Students Hub</div>

    <!-- Home added at top per Option A -->
    <div class="nav-item active" data-page="home"><div class="icon">üè†</div><div>Home</div></div>
    <div class="nav-item" data-page="quickserve"><div class="icon">‚ö°</div><div>QuickServe</div></div>
    <div class="nav-item" data-page="facultyfinder"><div class="icon">üë©‚Äçüè´</div><div>Faculty Finder</div></div>
    <div class="nav-item" data-page="whatsinmess"><div class="icon">üç¥</div><div>What's in Mess</div></div>
    <div class="nav-item" data-page="explorecampus"><div class="icon">üó∫</div><div>Explore Campus</div></div>
    <div style="flex:1"></div>
    <div class="nav-item" data-page="settings"><div class="icon">‚öô</div><div>Settings</div></div>
  </div>

  <!-- MAIN -->
  <main class="main" id="main">
    <div class="top-nav">
      <a href="#" id="topHome">Home</a>
      <a href="#" id="topAbout">About</a>
      <a href="#" id="topFeedback">Feedback</a>
      <div id="authState" style="margin-left:12px"></div>
    </div>

    <!-- Page content will be injected here -->
    <div id="pageContent" style="width:100%"></div>
  </main>

  <!-- Login modal (in-page) -->
  <div id="loginModal" class="modal" style="display:none;" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <h3 id="loginTitle">Sign in to continue</h3>
      <div>
        <input id="loginUser" placeholder="Username" autocomplete="username">
        <input id="loginPass" type="password" placeholder="Password" autocomplete="current-password">
        <div id="loginError" style="color:#f88;margin-top:8px;display:none"></div>
        <div class="modal-actions">
          <button id="loginCancel" class="action-button" style="background:#444;color:#fff;padding:8px 12px">Cancel</button>
          <button id="loginSubmit" class="action-button" style="padding:8px 12px">Sign in</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Protection: disable right-click, keyboard devtools shortcuts,
   dragging and selecting (while keeping inputs usable)
   ========================= */
(function(){
  // disable context menu
  document.addEventListener('contextmenu', function(e){ e.preventDefault(); }, true);

  // disable dragstart globally
  document.addEventListener('dragstart', function(e){ e.preventDefault(); }, true);

  // insert CSS that disables selection/dragging but re-enables inputs/textarea/contenteditable
  var css = '*{user-select:none !important;-webkit-user-select:none !important;-ms-user-select:none !important;-webkit-user-drag:none !important;} input, textarea, [contenteditable]{user-select:text !important;-webkit-user-select:text !important;-ms-user-select:text !important;}';
  var _s = document.createElement('style'); _s.type = 'text/css'; _s.appendChild(document.createTextNode(css));
  (document.head || document.documentElement).appendChild(_s);

  // block keys: F12, Ctrl+Shift+I, Ctrl+Shift+C, Ctrl+U, Shift+F10
  document.addEventListener('keydown', function(e){
    var k = e.key || e.keyIdentifier || '';
    if(k === 'F12') { e.preventDefault(); e.stopPropagation(); return false; }
    if(e.ctrlKey && e.shiftKey && (k === 'I' || k === 'i' || k === 'C' || k === 'c')){ e.preventDefault(); e.stopPropagation(); return false; }
    if(e.ctrlKey && (k === 'U' || k === 'u')){ e.preventDefault(); e.stopPropagation(); return false; }
    if(e.shiftKey && (k === 'F10')){ e.preventDefault(); e.stopPropagation(); return false; }
  }, true);

  // prevent selection start (safety) and copying/cutting
  document.addEventListener('selectstart', function(e){
    var t = e.target;
    if(t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable)) return; // allow on inputs
    e.preventDefault();
  }, true);
  document.addEventListener('copy', function(e){ e.preventDefault(); }, true);
  document.addEventListener('cut', function(e){ e.preventDefault(); }, true);

  // small allowance: allow mousedown focus into inputs/textarea without blocking normal use
  document.addEventListener('mousedown', function(e){
    var el = e.target;
    if(el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable)) return;
  }, true);

})();

/* =========================
   App data & helpers
   ========================= */

/* small safe esc */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch])); }

/* -------------------------
   Authentication helpers
   ------------------------- */
async function isAuthenticated(){
  // Try server-side session first (works when served via the local Node server).
  try{
    const res = await fetch('/is-auth', { credentials: 'include' });
    if(res.ok){
      const j = await res.json();
      return !!j.authenticated;
    }
  }catch(e){
    // server not available ‚Äî fall back to localStorage
  }
  return localStorage.getItem('authenticated') === 'true';
}

function requireAuthRedirect(){
  // remember where to return after login
  try{ localStorage.setItem('returnTo', location.href); }catch(e){}
  // prefer server-hosted login page when available
  const tryUrl = '/login.html?returnTo=' + encodeURIComponent(location.href);
  location.href = tryUrl;
}

// In-page login modal flow (static credentials). Uses a pending callback to continue action after sign-in.
let _pendingAuthAction = null;
function showLoginModal(callback){
  _pendingAuthAction = callback || null;
  const modal = document.getElementById('loginModal');
  if(!modal) return;
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  setTimeout(()=> document.getElementById('loginUser').focus(), 10);
}
function hideLoginModal(){
  const modal = document.getElementById('loginModal');
  if(!modal) return;
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
  _pendingAuthAction = null;
}
async function handleLoginSubmit(){
  const user = (document.getElementById('loginUser')?.value || '').trim();
  const pass = document.getElementById('loginPass')?.value || '';
  // static check ‚Äî change as needed
  const OK_USER = 'student';
  const OK_PASS = 'campus123';
  if(user === OK_USER && pass === OK_PASS){
    try{ localStorage.setItem('authenticated','true'); localStorage.setItem('username', user); }catch(e){}
    hideLoginModal();
    updateLoginState();
    // run pending action if present
    if(typeof _pendingAuthAction === 'function'){
      const cb = _pendingAuthAction; _pendingAuthAction = null; cb();
    }
    return;
  }
  const err = document.getElementById('loginError');
  err.textContent = 'Invalid username or password'; err.style.display = 'block';
}
// wire modal buttons (if modal exists at script time)
setTimeout(()=>{
  const s = document.getElementById('loginSubmit');
  const c = document.getElementById('loginCancel');
  if(s) s.addEventListener('click', (e)=>{ e.preventDefault(); handleLoginSubmit(); });
  if(c) c.addEventListener('click', (e)=>{ e.preventDefault(); hideLoginModal(); });
  // allow Enter key to submit
  const userEl = document.getElementById('loginUser');
  const passEl = document.getElementById('loginPass');
  [userEl, passEl].forEach(el=>{ if(el) el.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter') handleLoginSubmit(); }); });
}, 50);

function updateLoginState(){
  const auth = localStorage.getItem('authenticated') === 'true';
  const username = localStorage.getItem('username') || '';
  const container = document.getElementById('authState');
  if(!container) return;
  if(auth){
    container.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><span id="usernameDisplay" style="font-weight:700;color:#fff">${escapeHtml(username)}</span><button id="logoutBtn" class="action-button" style="background:#444;color:#fff;padding:6px 8px">Logout</button></div>`;
    const lb = document.getElementById('logoutBtn');
    if(lb) lb.addEventListener('click', (e)=>{ e.preventDefault(); logout(); });
  } else {
    container.innerHTML = `<button id="authLoginBtn" class="action-button" style="padding:6px 8px">Login</button>`;
    const ab = document.getElementById('authLoginBtn');
    if(ab) ab.addEventListener('click', (e)=>{ e.preventDefault(); showLoginModal(); });
  }
}

function logout(){
  try{ localStorage.removeItem('authenticated'); localStorage.removeItem('username'); }catch(e){}
  updateLoginState();
}

/* ---------- Faculty data (kept from your second file) ---------- */
const facultyData = [
  {name:"Dr. R. Annie Uthra", title:"HOD", dept:"CINTEL", office:"TP2, 1106", email:"annie.u@campus.edu"},
  {name:"Dr. Maragatham G", title:"Professor", dept:"CINTEL", office:"TP2, 1117", email:"maragatg@campus.edu"},
  {name:"Dr. M. Uma", title:"Professor", dept:"CINTEL", office:"TP2, 1016", email:"umam@campus.edu"},
  {name:"Dr. S. Karthik", title:"Associate Professor", dept:"CSE", office:"TP1, 203", email:"karthik.s@campus.edu"},
  {name:"Dr. P. Lakshmi", title:"Assistant Professor", dept:"CSE", office:"TP1, 210", email:"lakshmi.p@campus.edu"},
  {name:"Dr. T. Ramesh", title:"Professor", dept:"ECE", office:"TP3, 402", email:"ramesh.t@campus.edu"},
  {name:"Dr. V. Nivedha", title:"Assistant Professor", dept:"AI&DS", office:"TP4, 109", email:"nivedha.v@campus.edu"},
  {name:"Dr. A. Prakash", title:"Associate Professor", dept:"IT", office:"TP2, 309", email:"prakash.a@campus.edu"},
  {name:"Dr. L. Meera", title:"Assistant Professor", dept:"CSE", office:"TP1, 215", email:"meera.l@campus.edu"},
  {name:"Dr. R. Kannan", title:"Professor", dept:"AI&DS", office:"TP4, 201", email:"kannan.r@campus.edu"},
  {name:"Dr. S. Poornima", title:"Assistant Professor", dept:"IT", office:"TP2, 321", email:"poornima.s@campus.edu"},
  {name:"Dr. N. Sathish", title:"Associate Professor", dept:"CSE", office:"TP1, 218", email:"sathish.n@campus.edu"}
];
const departments = ["All","CSE","CINTEL","IT","AI&DS","ECE","Others"];

/* Icons used in faculty cards */
const svgBook = '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 5.5A2.5 2.5 0 0 1 5.5 3H19" stroke="#cfcfcf" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 21V6.5a2.5 2.5 0 0 1 2.5-2.5H19" stroke="#cfcfcf" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/></svg>';
const svgPin = '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 11.5a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" stroke="#cfcfcf" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/><path d="M17.657 10.343A6 6 0 1 0 6 11.999v0C6 16 12 22 12 22s6-6 6-10 0-.001-.343-.657z" stroke="#cfcfcf" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/></svg>';
const svgMail = '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 8.5v7a2.5 2.5 0 0 0 2.5 2.5h13A2.5 2.5 0 0 0 21 15.5v-7" stroke="#cfcfcf" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 7l-9 6-9-6" stroke="#cfcfcf" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/></svg>';

/* -------------------------
   Mess menu (from first file)
   ------------------------- */
;

/* -------------------------
   Page templates (Home from first file)
   ------------------------- */
const pages = {
  home: `
    <nav class="top-nav" style="justify-content:flex-start;margin-bottom:18px">
      <a href="#" class="active" style="margin-right:auto;color:#fff;font-weight:700">Home</a>
      <button class="login-button" onclick="alert('Login functionality here')">Login</button>
      
    
    </nav>

    <div class="card-container" style="margin-top:6px">
      <div class="card" data-page="quickserve">
        <div class="card-emoji">‚ö°</div>
        <div class="card-title">QuickServe</div>
        <div class="card-desc">
          No more asking friends for menus or outlet numbers ‚Äî browse all campus food spots with prices and call to order in one tap.
        </div>
        <button class="card-button" onclick="loadPage('quickserve')">Browse & Order</button>
      </div>

      <div class="card" data-page="facultyfinder">
        <div class="card-emoji">üë©‚Äçüè´</div>
        <div class="card-title">Faculty Finder</div>
        <div class="card-desc">
          Search and connect with faculty members across departments ‚Äî find contacts and reach out easily.
        </div>
        <button class="card-button" onclick="loadPage('facultyfinder')">Find Faculty</button>
      </div>

      <div class="card" data-page="whatsinmess">
        <div class="card-emoji">üç¥</div>
        <div class="card-title">What's in Mess</div>
        <div class="card-desc">
          Check daily mess menus to know what‚Äôs cooking in your mess ‚Äî updated meal options and timings at your fingertips.
        </div>
        <button class="card-button" onclick="loadPage('whatsinmess')">Check Menu</button>
      </div>

      <div class="card" data-page="explorecampus">
        <div class="card-emoji">üó∫</div>
        <div class="card-title">Explore Campus</div>
        <div class="card-desc">
          Discover campus locations, events, and points of interest with interactive maps and guides.
        </div>
        <button class="card-button" onclick="loadPage('explorecampus')">Explore Now</button>
      </div>
    </div>
  `,
  quickserve: `
    <nav class="top-nav" style="justify-content:flex-start;margin-bottom:18px">
      <a href="#" onclick="loadPage('home')" style="margin-right:auto;color:#9e9e9e">Home</a>
      <a href="#" style="margin-left:12px">About</a>
      <a href="#" style="margin-left:8px">Feedback</a>
    </nav>

    <h1 style="font-size:28px;margin-bottom:6px;color:#fff">QuickServe</h1>
    <p style="color:var(--green);margin-bottom:18px">Browse campus food menus with prices and call the outlet to place your order.</p>

    <input type="text" placeholder="Search for outlets or dishes..." id="quickserveSearch" style="width:100%;background:var(--input);border-radius:12px;padding:12px 14px;color:#ddd;border:1px solid rgba(255,255,255,0.03);margin-bottom:18px" />

    <div class="food-card-container" id="quickserveList">
      <div class="food-card">
        <img src="https://woxsen.edu.in/uploads/A20230612060022.webp" alt="Blu Embers">
        <div class="food-info">
          <h3>Blu Embers</h3>
          <p style="color:#bdbdbd;margin:6px 0 12px">
            <li>
            <ul>  Wednesday:05:00 PM 05:30 PM <ul>
<ul>  Thursday: 05:00 PM - 05:30 PM <ul>
  <ul>  Friday 05:00 PM - 05:30 PM <ul>
    <ul>Saturday 05:00 PM 05:30 PM<ul>
      <ul>  Sunday: 05:00 PM - 05:30 PM <ul>
        <ul>  Monday: 05:00 PM - 05:30 PM <ul>
          <ul>  Tuesday: 05:00 PM - 05:30 PM <ul><p>

        </div>
        <button class="action-button quickserve-menu" onclick="alert('Calling Google Plus to place order...')">Menu</button>
      </div>

      <div class="food-card">
        <img src="https://images.unsplash.com/photo-1565299613290-4154f6abf0ee?auto=format&fit=crop&w=900&q=60" alt="Google Food Park">
        <div class="food-info">
          <h3>New Embers</h3>
          <p style="color:#bdbdbd;margin:6px 0 12px">Outlet at Java, Get Free Hostel Delivery!</p>
        </div>
        <button class="action-button quickserve-menu" onclick="alert('Calling Google Food Park to place order...')">Menu</button>
      </div>

      <div class="food-card">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRhTrFbQV8YRLO0XUtRfRAjVo_oArWE-65jbw&s" alt="Butty">
        <div class="food-info">
          <h3>Rise</h3>
          <p style="color:#bdbdbd;margin:6px 0 12px">
            
            <li>
            <ul>  Wednesday:09:00 AM 9:00 PM <ul>
          <ul>  Thursay:09:00 AM 9:00 PM <ul>
            <ul>  Friday:09:00 AM 9:00 PM <ul>
              <ul>  Saturday:09:00 AM 9:00 PM <ul>
                <ul>  Sunday:09:00 AM 9:00 PM <ul>
                  <ul>  Monday:09:00 AM 9:00 PM <ul>
                    <ul>  Tuesday:09:00 AM 9:00 PM <ul><p>
          </p>
        </div>
        <button class="action-button quickserve-menu" onclick="alert('Calling Butty to place order...')">Menu</button>
      </div>
      <div class="food-card">
        <img src="https://woxsen.edu.in/uploads/A20230612060158.webp">
        <div class="food-info">
          <h3>Cup of Joe</h3>
          <p style="color:#bdbdbd;margin:6px 0 12px">Outlet at Java, Get Free Hostel Delivery!</p>
        </div>
        <button class="action-button quickserve-menu" onclick="alert('Calling Google Food Park to place order...')">Menu</button>
      </div>
    </div>
  `,
  facultyfinder: `
    <div id="facultyFinderRoot">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <div class="page-header" style="font-size:32px;margin:0;color:#ff6b6b">Faculty Finder</div>
          <div class="page-subheader" style="margin-top:6px">Search and connect with faculty members across departments.</div>
        </div>
      </div>

      <div class="finder-controls" style="margin-top:20px">
        <div class="search-input" id="searchInput">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" style="opacity:0.7"><path d="M21 21l-4.35-4.35" stroke="#aaa" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#aaa" stroke-width="1.5"/></svg>
          <input id="facultySearch" placeholder="Search by name or designation..." aria-label="Search faculty">
        </div>

        <div class="dropdown" id="deptDropdown" role="listbox" aria-label="Filter department">
          <span id="deptSelected">All</span>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="#bbb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>

      <div class="faculty-grid" id="facultyGrid" aria-live="polite" style="margin-top:18px"></div>
    </div>
  `,
  whatsinmess: `
    <nav class="top-nav" style="justify-content:flex-start;margin-bottom:18px">
      <a href="#" onclick="loadPage('home')" style="margin-right:auto;color:#9e9e9e">Home</a>
      <a href="#" style="margin-left:12px">About</a>
      <a href="#" style="margin-left:8px">Feedback</a>
    </nav>

    <h1 class="page-header" style="font-size:28px;margin-bottom:6px">What's in Mess</h1>

    <div class="mess-tabs" role="tablist" aria-label="Mess selection">
      <div class="mess-tab active" data-mess="oval">oval</div>
      
    </div>

  

  

    <!-- Upload control added here -->
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
      <label style="font-weight:700;color:#cfcfcf">Upload menu:</label>
      <input type="file" id="menuUpload" accept="image/*,text/plain" style="display:none" />
      <button id="uploadBtn" class="action-button" style="padding:8px 12px;background:#666">Choose File</button>
      <button id="applyUploadBtn" class="action-button" style="padding:8px 12px">Apply</button>
      <button id="clearUploadBtn" class="action-button" style="background:#444;color:#fff;padding:8px 12px">Clear</button>
    </div>
    <div id="uploadPreview" style="display:flex;gap:12px;align-items:center;margin-bottom:12px"></div>

    <div id="meal-items" class="meal-section" aria-live="polite" style="margin-top:12px"></div>
  `,
  explorecampus: `
  <nav class="top-nav" style="justify-content:flex-start;margin-bottom:18px">
    <a href="#" onclick="loadPage('home')" style="margin-right:auto;color:#9e9e9e">Home</a>
  </nav>

  <h1 style="font-size:28px;margin-bottom:6px;color:#fff">Explore Campus</h1>
  <p style="color:var(--green);margin-bottom:18px">Discover popular places inside campus.</p>

  <div class="food-card-container">

    <div class="food-card">
      <img src="https://woxsen.edu.in/uploads/A20240611064133.webp" alt="SportX">
      <div class="food-info">
        <h3>SportX Arena</h3>
        <p style="color:#bdbdbd;margin:6px 0 12px">Indoor & outdoor courts for badminton, squash, basketball & more.</p>
      </div>
    </div>

    <div class="food-card">
      <img src="https://woxsen.edu.in/uploads/A20240330030638.webp" alt="Library">
      <div class="food-info">
        <h3>Central Library</h3>
        <p style="color:#bdbdbd;margin:6px 0 12px">A peaceful study space with thousands of books & digital resources.</p>
      </div>
    </div>

    <div class="food-card">
      <img src="https://woxsen.edu.in/uploads/A20230522054130.webp" alt="Admin Block">
      <div class="food-info">
        <h3>Admin Block</h3>
        <p style="color:#bdbdbd;margin:6px 0 12px">Administrative offices, admissions & student support services.</p>
      </div>
    </div>

    <div class="food-card">
      <img src="https://woxsen.edu.in/uploads/A20240722074042.webp" alt="RACE">
      <div class="food-info">
        <h3>RACE</h3>
        <p style="color:#bdbdbd;margin:6px 0 12px">Research & Advanced Computing Excellence center.</p>
      </div>
    </div>

  </div>
`,

};

/* -------------------------
   App behavior
   ------------------------- */

/* Sidebar nav items */
const navItems = document.querySelectorAll('.nav-item');

function setActiveNav(page){
  navItems.forEach(n=> n.classList.toggle('active', n.dataset.page===page));
  // also set top nav active link text color for Home
  document.getElementById('topHome').style.color = (page === 'home') ? '#fff' : '#9e9e9e';
}

/* Render faculty finder content (wires up search/filters) */
function renderFacultyFinder(){
  // replace content with template already set
  document.getElementById('pageContent').innerHTML = pages.facultyfinder;

  // wire up search and dropdown after DOM insertion
  const searchEl = document.getElementById('facultySearch');
  const deptDropdown = document.getElementById('deptDropdown');
  const deptSelected = document.getElementById('deptSelected');

  deptDropdown.addEventListener('click', ()=>{ 
    const opts = departments.map((d,i)=>`${i+1}. ${d}`).join('\n');
    const choice = prompt("Select department (enter number):\n\n" + opts, "1");
    if(!choice) return;
    const idx = parseInt(choice,10)-1;
    if(isNaN(idx) || idx<0 || idx>=departments.length){ alert("Invalid selection"); return; }
    deptSelected.textContent = departments[idx];
    applyFacultyFilters();
  });

  if(searchEl) {
    searchEl.addEventListener('input', ()=>applyFacultyFilters());
  }

  // initial render
  renderFacultyCards(facultyData);
}

function renderFacultyCards(list){
  const grid = document.getElementById('facultyGrid');
  if(!grid) return;
  if(list.length === 0){
    grid.innerHTML = `<div style="color:#bdbdbd;padding:24px">No faculty found.</div>`;
    return;
  }
  grid.innerHTML = list.map(f => `
    <div class="faculty-card" role="article" aria-label="${escapeHtml(f.name)}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
        <div style="flex:1">
          <div class="faculty-name">${escapeHtml(f.name)}</div>
          <div class="faculty-role">${escapeHtml(f.title)}</div>
        </div>
        <div class="dept-pill">${escapeHtml(f.dept)}</div>
      </div>
      <div class="faculty-meta">
        <div class="meta-row">${svgBook} <span>${escapeHtml(f.dept)}</span></div>
        <div class="meta-row">${svgPin} <span>${escapeHtml(f.office)}</span></div>
        <div class="meta-row">${svgMail} <a class="email-link" href="mailto:${encodeURIComponent(f.email)}">${escapeHtml(f.email)}</a></div>
      </div>
    </div>
  `).join('');
}

function applyFacultyFilters(){
  const q = (document.getElementById('facultySearch')?.value || '').trim().toLowerCase();
  const dept = (document.getElementById('deptSelected')?.textContent || 'All');

  const filtered = facultyData.filter(f=>{
    if(dept && dept !== 'All' && dept !== 'Others' && f.dept !== dept) return false;
    if(dept === 'Others'){
      const known = ["CSE","CINTEL","IT","AI&DS","ECE"];
      if(known.includes(f.dept)) return false;
    }
    if(!q) return true;
    const hay = (f.name + ' ' + f.title + ' ' + f.dept + ' ' + f.office).toLowerCase();
    return hay.indexOf(q) !== -1;
  });

  renderFacultyCards(filtered);
}

/* QuickServe search */
function addQuickserveSearch() {
  const searchBox = document.getElementById('quickserveSearch');
  const list = document.getElementById('quickserveList');
  if(!searchBox || !list) return;
  const cards = list.querySelectorAll('.food-card');

  searchBox.addEventListener('input', () => {
    const query = searchBox.value.toLowerCase();
    cards.forEach(card => {
      const title = (card.querySelector('h3')?.textContent || '').toLowerCase();
      const desc = (card.querySelector('p')?.textContent || '').toLowerCase();
      card.style.display = (title.includes(query) || desc.includes(query)) ? '' : 'none';
    });
  });
}

/* WhatsInMess interactions */
let currentMess = "oval";


function renderMealItems() {
  const mealItemsContainer = document.getElementById('meal-items');
  if(!mealItemsContainer) return;
  // if an uploaded image exists for this selection, render it (and continue to show textual items if present)
  const imgKey = `${currentMess}|${currentDay}|${currentMeal}`;
  const uploadedImg = (window._messImages && window._messImages[imgKey]) ? window._messImages[imgKey] : null;

  const items = (messMenu[currentMess] && messMenu[currentMess][currentDay] && messMenu[currentMess][currentDay][currentMeal]) || [];

  if (!items.length && !uploadedImg) {
    mealItemsContainer.innerHTML = `<p style=\"color:#bdbdbd">No menu available for this selection.</p>`;
    return;
  }

  let colorClass = "item-breakfast";
  if (currentMeal === "breakfast") colorClass = "item-breakfast";
  else if (currentMeal === "lunch") colorClass = "item-lunch";
  else if (currentMeal === "dinner") colorClass = "item-dinner";
  else if (currentMeal === "snacks") colorClass = "item-snacks";

  const itemsHtml = items.map(item =>
    `<div class=\"item-box ${colorClass}\">${escapeHtml(item)}</div>`
  ).join('');

  const imgHtml = uploadedImg ? `<div style=\"width:100%\"><img src=\"${uploadedImg}\" style=\"max-width:100%;border-radius:8px;box-shadow:0 6px 16px rgba(0,0,0,0.6);margin-bottom:12px\"></div>` : '';

  mealItemsContainer.innerHTML = imgHtml + itemsHtml;
}

function setActiveTab(tabButtons, activeValue, valueAttr = "data-mess") {
  tabButtons.forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute(valueAttr) === activeValue);
  });
}

function addWhatsInMessEvents() {
  const messTabs = document.querySelectorAll('.mess-tab');
  messTabs.forEach(tab => {
    tab.onclick = () => {
      currentMess = tab.getAttribute('data-mess');
      setActiveTab(messTabs, currentMess);
      renderMealItems();
    };
  });

  const dayTabs = document.querySelectorAll('.day-tab');
  dayTabs.forEach(tab => {
    tab.onclick = () => {
      currentDay = tab.getAttribute('data-day');
      setActiveTab(dayTabs, currentDay, 'data-day');
      renderMealItems();
    };
  });

  const mealTabs = document.querySelectorAll('.meal-tab');
  mealTabs.forEach(tab => {
    tab.onclick = () => {
      currentMeal = tab.getAttribute('data-meal');
      setActiveTab(mealTabs, currentMeal, 'data-meal');
      renderMealItems();
    };
  });

  // Upload handlers (wire after DOM insertion)
  const uploadInput = document.getElementById('menuUpload');
  const applyBtn = document.getElementById('applyUploadBtn');
  const clearBtn = document.getElementById('clearUploadBtn');
  const uploadPreview = document.getElementById('uploadPreview');
  let stagedMenuItems = null;
  let stagedImageData = null;

  if (uploadInput && uploadPreview && applyBtn && clearBtn) {
    // wire visible upload button to require authentication before opening file picker
    const uploadBtn = document.getElementById('uploadBtn');
    if(uploadBtn){
      uploadBtn.addEventListener('click', async (e)=>{
        const auth = await isAuthenticated();
        if(!auth){
          // show login modal; after successful login the callback will open the file dialog
          showLoginModal(()=> { setTimeout(()=> uploadInput.click(), 50); });
          return;
        }
        // already authenticated ‚Äî open file picker
        uploadInput.click();
      });
    }

    uploadInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      stagedMenuItems = null;
      stagedImageData = null;
      uploadPreview.innerHTML = '';
      if (!file) return;

      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          stagedImageData = ev.target.result;
          uploadPreview.innerHTML = `<img src=\"${stagedImageData}\" style=\"max-width:120px;border-radius:8px\">`;
        };
        reader.readAsDataURL(file);
      } else if (file.type === 'text/plain' || file.name.toLowerCase().endsWith('.txt')) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          stagedMenuItems = (ev.target.result || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          uploadPreview.innerHTML = `<div style=\"color:#bdbdbd;max-width:600px\"><strong>Parsed items:</strong><div style=\"margin-top:8px\">${stagedMenuItems.map(i => `<div style=\"padding:4px 0\">‚Ä¢ ${escapeHtml(i)}</div>`).join('')}</div></div>`;
        };
        reader.readAsText(file);
      } else {
        uploadPreview.innerHTML = `<div style=\"color:#f88\">Unsupported file type</div>`;
      }
    });

    const doApply = () => {
      messMenu[currentMess] = messMenu[currentMess] || {};
      messMenu[currentMess][currentDay] = messMenu[currentMess][currentDay] || {};
      if (stagedMenuItems) {
        messMenu[currentMess][currentDay][currentMeal] = stagedMenuItems;
        renderMealItems();
        alert('Menu applied from uploaded text.');
      } else if (stagedImageData) {
        if (!window._messImages) window._messImages = {};
        window._messImages[`${currentMess}|${currentDay}|${currentMeal}`] = stagedImageData;
        renderMealItems();
        alert('Image uploaded and saved for this selection.');
      } else {
        alert('No uploaded menu to apply.');
      }
    };

    applyBtn.onclick = async () => {
      const auth = await isAuthenticated();
      if (!auth) {
        showLoginModal(doApply);
        return;
      }
      doApply();
    };

    clearBtn.onclick = () => {
      uploadInput.value = '';
      stagedMenuItems = null;
      stagedImageData = null;
      uploadPreview.innerHTML = '';
      if (window._messImages) {
        delete window._messImages[`${currentMess}|${currentDay}|${currentMeal}`];
      }
      renderMealItems();
    };
  }
}

/* Page loader */
function loadPage(page){
  setActiveNav(page);
  if(page === 'facultyfinder'){
    renderFacultyFinder();
  } else {
    document.getElementById('pageContent').innerHTML = pages[page] || `<div style=\"padding:24px\">Page: ${page}</div>`;
    // post-load hookups
    if(page === 'quickserve') {
      // allow small delay before hooking search
      setTimeout(()=> addQuickserveSearch(), 0);
    } else if(page === 'whatsinmess') {
      // initialize mess interactions
      setTimeout(()=> {
        addWhatsInMessEvents();
        renderMealItems();
      }, 0);
    }
  }
}

/* wire sidebar nav clicks */
navItems.forEach(n=>{
  n.addEventListener('click', ()=>{
    const page = n.dataset.page;
    loadPage(page);
  });
});

/* top nav home link */
document.getElementById('topHome').addEventListener('click',(e)=>{ e.preventDefault(); loadPage('home'); });

// initialize auth UI and start on home
setTimeout(()=>{
  updateLoginState();
  loadPage('home');
}, 20);

</script>
</body>
</html>
